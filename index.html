<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Universal Search â€” Tomouh</title>
    <link rel="stylesheet" href="style.css" />
</head>

<body>
    <div class="search-wrapper" id="wrapper">
        <div class="search-bar">
            <textarea id="query" rows="1" placeholder="Type your search... (Shift+Enter for newline)"></textarea>
            <div id="selectButton" class="select-root">
                <img class="icon" id="selectedIcon" src="https://www.google.com/favicon.ico" alt="">
                <span id="selectedLabel">Google</span>
            </div>
            <button id="searchBtn" class="btn">Go</button>
        </div>
        <div class="hints">
            <div class="hint"><span class="kbd">Enter</span><span>Go</span></div>
            <div class="hint"><span class="kbd">Shift+Enter</span><span>New line</span></div>
            <div class="hint"><span class="kbd">Esc</span><span>Close</span></div>
        </div>
    </div>

    <script>
        (async () => {
            if (!window.electronAPI) {
                console.error('electronAPI is not available!');
                return;
            }

            const engines = await window.electronAPI.requestEngines(); // NEW

            const wrapper = document.getElementById("wrapper");
            const queryBox = document.getElementById("query");
            const selectBtn = document.getElementById("selectButton");
            const selectLabel = document.getElementById("selectedLabel");
            const selectIcon = document.getElementById("selectedIcon");

            let current = 0;
            function selectEngine(i) {
                current = i;
                selectIcon.src = engines[i].icon;
                selectLabel.textContent = engines[i].label;
            }
            selectEngine(0);

            // Focus/blur styling
            queryBox.addEventListener("focus", () => wrapper.classList.add("focused"));
            queryBox.addEventListener("blur", () => wrapper.classList.remove("focused"));

            // Auto-resize
            queryBox.addEventListener("input", () => {
                queryBox.style.height = "auto";
                const scrollH = Math.min(queryBox.scrollHeight, 200);
                queryBox.style.height = scrollH + "px";
                window.electronAPI.adjustHeight(scrollH + 80);
            });

            // Focus from main
            window.electronAPI.onFocusQuery(() => {
                queryBox.focus();
                queryBox.selectionStart = queryBox.value.length;
            });

            // Menu toggle
            selectBtn.onclick = async (e) => {
                e.stopPropagation();
                const rect = selectBtn.getBoundingClientRect();
                const { x: winX, y: winY } = await window.electronAPI.getWindowPosition();

                const menuX = Math.round(winX + rect.left);
                const menuY = Math.round(winY + rect.bottom);

                window.electronAPI.toggleMenuAt({ x: menuX, y: menuY });
            };

            // Close menu on click outside
            document.addEventListener("click", () => window.electronAPI.closeMenu());

            // Engine selected from menu
            window.electronAPI.onEngineSelected((e, i) => selectEngine(i));

            // Search
            document.getElementById("searchBtn").onclick = () => {
                const q = queryBox.value.trim();
                if (!q) return;
                const e = engines[current];
                window.electronAPI.openURL(e.url + encodeURIComponent(q));
            };

            // Keyboard shortcuts
            queryBox.addEventListener("keydown", (e) => {
                if (e.key === "Enter" && !e.shiftKey) {
                    e.preventDefault();
                    document.getElementById("searchBtn").click();
                } else if (e.key === "Escape") {
                    window.electronAPI.hideWindow();
                }
            });
        })();
    </script>

</body>

</html>